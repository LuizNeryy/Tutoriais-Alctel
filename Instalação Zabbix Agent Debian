````markdown
# Tutorial de Instala√ß√£o e Configura√ß√£o do Zabbix Agent 2

Este guia detalha o processo de instala√ß√£o, configura√ß√£o e libera√ß√£o de firewall para o Zabbix Agent 2 em um sistema Debian, baseado em um log de execu√ß√£o real.

---

### 1. Prepara√ß√£o do Ambiente üîë

Primeiro, √© necess√°rio obter privil√©gios de superusu√°rio (root) para poder instalar pacotes e editar arquivos de configura√ß√£o do sistema.

```bash
sudo su -
````

  * **`sudo su -`**: Muda do usu√°rio atual para o usu√°rio `root`, carregando o perfil completo do `root`, o que garante que todas as permiss√µes e vari√°veis de ambiente estejam corretas.

-----

### 2\. Instala√ß√£o do Zabbix Agent 2 üì¶

O pr√≥ximo passo √© usar o gerenciador de pacotes `apt` para instalar o Zabbix Agent 2.

```bash
apt install zabbix-agent2
```

  * **`apt install zabbix-agent2`**: Baixa e instala o pacote `zabbix-agent2` e suas depend√™ncias a partir dos reposit√≥rios configurados no sistema Debian.

-----

### 3\. Configura√ß√£o do Agente ‚öôÔ∏è

Esta √© a etapa mais importante, onde o arquivo de configura√ß√£o do agente √© modificado para apontar para o seu servidor Zabbix e para ajustar outros par√¢metros.

O bloco de comandos abaixo foi projetado para ser copiado e colado diretamente no terminal.

> **Aten√ß√£o:** No log original, o `hostname` utilizado foi `portal10.contactfy.cloud`. No comando `sed` abaixo, est√° `portal1`, conforme a solicita√ß√£o. Certifique-se de usar o nome do host **exatamente** como ele est√° cadastrado no seu servidor Zabbix.

```bash
# Navega para o diret√≥rio de configura√ß√£o
cd /etc/zabbix/

# Cria um backup do arquivo de configura√ß√£o original
mv zabbix_agent2.conf zabbix_agent2.conf.original

# Cria um novo arquivo de configura√ß√£o com um cabe√ßalho
echo "##### Zabbix Agent #####" >> /etc/zabbix/zabbix_agent2.conf

# Copia apenas as configura√ß√µes ativas (sem coment√°rios ou linhas vazias) do backup para o novo arquivo
cat zabbix_agent2.conf.original | grep -Ev '^#|^$' >> zabbix_agent2.conf

# Altera o IP do servidor Zabbix para onde o agente ir√° reportar
sed -i 's/127.0.0.1/172.31.248.244/g' /etc/zabbix/zabbix_agent2.conf

# Altera o hostname do servidor Zabbix (para checagens ativas)
sed -i 's/Zabbix server/portal1/g' /etc/zabbix/zabbix_agent2.conf

# Adiciona um tempo limite customizado para as checagens
echo "Timeout=15" >> /etc/zabbix/zabbix_agent2.conf

# Define o n√≠vel de log para depura√ß√£o, √∫til para diagnosticar problemas
echo "DebugLevel=3" >> /etc/zabbix/zabbix_agent2.conf

# Habilita o servi√ßo para iniciar automaticamente com o sistema
systemctl enable zabbix-agent2

# Reinicia o servi√ßo do agente para aplicar as novas configura√ß√µes
systemctl restart zabbix-agent2

# Verifica o status do servi√ßo para confirmar que ele est√° rodando
systemctl status zabbix-agent2.service
```

-----

### 4\. Verifica√ß√£o e Diagn√≥stico (Logs) ü©∫

Ap√≥s a primeira configura√ß√£o, √© crucial verificar os logs para garantir que n√£o h√° erros. No log original, foi encontrado um erro de "host not found". Este comando √© usado para visualizar os logs em tempo real.

```bash
tail -f /var/log/zabbix/zabbix_agent2.log
```

  * **`tail -f`**: Exibe as √∫ltimas linhas do arquivo de log e continua monitorando o arquivo, mostrando novas linhas √† medida que s√£o adicionadas. √â a principal ferramenta para depurar o agente em tempo real.

-----

### 5\. Configura√ß√£o do Firewall üõ°Ô∏è

Um erro de comunica√ß√£o geralmente √© causado por um firewall bloqueando a porta necess√°ria. Os comandos a seguir verificam o status do firewall (`firewalld`) e abrem a porta `10050/tcp` para a comunica√ß√£o entre o servidor e o agente Zabbix.

```bash
# Verifica se o servi√ßo do firewall est√° ativo
systemctl status firewalld.service

# Lista as regras de firewall atuais (vis√£o do iptables)
iptables -L

# Lista a configura√ß√£o completa da zona ativa do firewalld
firewall-cmd --list-all

# Lista apenas as portas que j√° est√£o abertas
firewall-cmd --list-ports

# Adiciona a porta 10050/tcp √† zona p√∫blica de forma permanente
firewall-cmd --permanent --add-port=10050/tcp

# Recarrega as regras do firewall para aplicar as altera√ß√µes permanentes
firewall-cmd --reload

# Confirma que a porta foi adicionada com sucesso
firewall-cmd --list-ports
```

-----

### 6\. Reinicializa√ß√£o Final e Verifica√ß√£o ‚úÖ

Ap√≥s ajustar o firewall, o servi√ßo do agente √© reiniciado e verificado uma √∫ltima vez para garantir que tudo est√° funcionando corretamente e que os erros de comunica√ß√£o desapareceram.

```bash
# Reinicia o servi√ßo do agente
systemctl restart zabbix-agent2.service

# Verifica o status do servi√ßo para confirmar que subiu sem erros
systemctl status zabbix-agent2.service

# Acompanha os logs novamente para verificar se a conex√£o foi estabelecida com sucesso
tail -f /var/log/zabbix/zabbix_agent2.log
```

Com estes passos, o Zabbix Agent 2 deve estar instalado, configurado e comunicando-se corretamente com o servidor Zabbix.

```
```
